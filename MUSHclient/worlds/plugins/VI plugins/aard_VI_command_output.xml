<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="Aardwolf_VI_Command_Output"
   author="Fiendish"
   id="fefc7923b4db9e0ee3add286"
   language="Lua"
   purpose="Capture command feedback"
   date_written="2016-02-14"
   requires="5.01"
   version="0.1"
   save_state="y"
>

<description trim="y">
</description>
  
</plugin>
<aliases>
<alias
   script="capture_activate"
   match="^mc command (.+)$"
   enabled="y"
   regexp="y"
   sequence="100"
   ignore_case="y"
>
</alias>
</aliases>

<triggers>
<trigger
   enabled="y"
   name="begin_capture"
   match="^\{Begin MC Capture:(.*)\}$"
   regexp="y"
   script="begin_capture"
   sequence="100"
   omit_from_output="y"
></trigger>

<trigger
   enabled="n"
   name="capture_body"
   match="^.*$"
   regexp="y"
   script="capture_body"
   sequence="101"
   omit_from_output="y"
></trigger>

<trigger
   enabled="y"
   name="end_capture"
   match="^\{End MC Capture:(.*)\}$"
   regexp="y"
   script="end_capture"
   sequence="100"
   omit_from_output="y"
>
</trigger>

<trigger
   enabled="n"
   name="blank_line"
   match="^$"
   regexp="y"
   sequence="100"
   omit_from_output="y"
   send_to="14"
>
<send>
   EnableTrigger("blank_line", false)
</send>
</trigger>

</triggers>

<script>
<![CDATA[

command_capture = "command output"
last_command = ""
in_command = ""

require "checkplugin"
function OnPluginListChanged()
   -- check we have necessary plugins
   do_plugin_check_now("dd10517422bc35b5131a3aa0", "VI_captures")
end

function OnPluginSaveState()
end

function capture_activate(name, line, wildcards, styles)
   last_command = Trim(wildcards[1])
   SendNoEcho("echo {Begin MC Capture:"..last_command.."}")
   SendNoEcho(last_command)
   SendNoEcho("echo {End MC Capture:"..last_command.."}")
end

function capture_body(name, line, wildcards, styles)
   if Trim(line) ~= "" then
      CallPlugin("dd10517422bc35b5131a3aa0", "stamp_and_store", command_capture, line)
   end
end

function begin_capture(name, line, wildcards, styles)
   in_command = Trim(wildcards[1])
   if last_command == in_command then
      EnableTrigger("capture_body", true)
      CallPlugin("dd10517422bc35b5131a3aa0", "remove_capture_internal", command_capture, true)
      CallPlugin("dd10517422bc35b5131a3aa0", "add_capture_if_new", command_capture, false, true, nil, false)
      CallPlugin("dd10517422bc35b5131a3aa0", "switch_to_capture", command_capture, true)
      CallPlugin("dd10517422bc35b5131a3aa0", "clear_capture", true)
      CallPlugin("dd10517422bc35b5131a3aa0", "stamp_and_store", command_capture, "Captured output for command ["..last_command.."].")
   end
end

function end_capture(name, line, wildcards, styles)
   EnableTrigger("blank_line", true)
   EnableTrigger("capture_body", false)
   if (last_command ~= "") and (last_command == in_command) then
      CallPlugin("dd10517422bc35b5131a3aa0", "show", "Captured output from command ["..last_command.."] to ["..command_capture.."] capture.")
      CallPlugin("dd10517422bc35b5131a3aa0", "switch_to_capture", command_capture)
      last_command = ""
   end
end

]]>
</script>
</muclient>
