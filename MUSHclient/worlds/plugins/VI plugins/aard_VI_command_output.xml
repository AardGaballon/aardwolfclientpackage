<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>

<muclient>
<plugin
   name="Aardwolf_VI_Command_Output"
   author="Fiendish"
   id="fefc7923b4db9e0ee3add286"
   language="Lua"
   purpose="Capture command feedback"
   date_written="2016-02-14"
   requires="4.70"
   version="0.1"
   save_state="y"
>

<description trim="y">
</description>
  
</plugin>
<aliases>
<alias
   script="capture_activate"
   match="^mc command (.+)$"
   enabled="y"
   regexp="y"
   sequence="100"
   ignore_case="y"
>
</alias>

<alias
   match="^mc buffer capture$"
   enabled="y"
   regexp="y"
   sequence="100"
   ignore_case="y"
   send_to="12"
>
<send>
  use_notepad = not use_notepad
  SetVariable("use_notepad", use_notepad and "1" or "0")
  if not use_notepad then
     do_plugin_check_now("dd10517422bc35b5131a3a0", "VI_captures")
  end
  Note("MC command captures will be sent to a "..(use_notepad and "notepad tab" or "capture buffer")..".")
</send>
</alias>
</aliases>

<triggers>
<trigger
   enabled="y"
   name="begin_capture"
   match="^\{Begin MC Capture:(.*)\}$"
   regexp="y"
   script="begin_capture"
   sequence="100"
   omit_from_output="y"
></trigger>

<trigger
   enabled="n"
   name="capture_body"
   match="^.*$"
   regexp="y"
   script="capture_body"
   sequence="101"
   omit_from_output="y"
></trigger>

<trigger
   enabled="y"
   name="end_capture"
   match="^\{End MC Capture:(.*)\}$"
   regexp="y"
   script="end_capture"
   sequence="100"
   omit_from_output="y"
>
</trigger>

<trigger
   enabled="n"
   name="blank_line"
   match="^$"
   regexp="y"
   sequence="100"
   omit_from_output="y"
   send_to="14"
>
<send>
   EnableTrigger("blank_line", false)
</send>
</trigger>

</triggers>

<script>
<![CDATA[

command_capture = "command output"
last_command = ""
in_command = ""
use_notepad = GetVariable("use_notepad")
if use_notepad == nil then
   use_notepad = true
else
   use_notepad = (use_notepad == "1")
end

function OnPluginDisconnect()
   EnableTrigger("capture_body", false)
   EnableTrigger("blank_line", false)
   last_command = ""
   in_command = ""
end

require "checkplugin"
function OnPluginListChanged()
   -- check we have necessary plugins
   do_plugin_check_now("dd10517422bc35b5131a3aa0", "VI_captures")
end

function capture_activate(name, line, wildcards, styles)
   last_command = Trim(wildcards[1])
   SendNoEcho("echo {Begin MC Capture:"..last_command.."}")
   SendNoEcho(last_command)
   SendNoEcho("echo {End MC Capture:"..last_command.."}")
end

temp_buffer = {}
function capture_body(name, line, wildcards, styles)
   line = line:gsub("^%[?%d%d %u%l%l %d%d:%d%d:%d%d%]? ?-? ","")
   table.insert(temp_buffer, line)
end


function begin_capture(name, line, wildcards, styles)
   in_command = Trim(wildcards[1])
   if last_command == in_command then
      EnableTrigger("capture_body", true)
   end
end

function end_capture(name, line, wildcards, styles)
   EnableTrigger("blank_line", true)
   EnableTrigger("capture_body", false)
   if (last_command ~= "") and (last_command == in_command) then
   
      while Trim(temp_buffer[1]) == "" do
         table.remove(temp_buffer, 1)
      end
      while Trim(temp_buffer[#temp_buffer]) == "" do
         table.remove(temp_buffer, #temp_buffer)
      end
      
      if use_notepad then
         local full_capture_string = ""
         for i,v in ipairs(temp_buffer) do
            full_capture_string = full_capture_string..v.."\n"
         end
         ReplaceNotepad(command_capture,  "Captured output for command ["..last_command.."].\n"..full_capture_string.."End of capture.")
         
         NotepadSaveMethod(command_capture, 2)
         NotepadReadOnly (command_capture, true)
         ActivateNotepad(command_capture)
      else
         CallPlugin("dd10517422bc35b5131a3aa0", "remove_capture_internal", command_capture, true)
         CallPlugin("dd10517422bc35b5131a3aa0", "add_capture_if_new", command_capture, false, true, nil, false)
         CallPlugin("dd10517422bc35b5131a3aa0", "switch_to_capture", command_capture, true)
         CallPlugin("dd10517422bc35b5131a3aa0", "clear_capture", true)
         CallPlugin("dd10517422bc35b5131a3aa0", "stamp_and_store", command_capture, "Captured output for command ["..last_command.."].")

         for i,v in ipairs(temp_buffer) do
            CallPlugin("dd10517422bc35b5131a3aa0", "stamp_and_store", command_capture, v)
         end
         
         CallPlugin("dd10517422bc35b5131a3aa0", "show", "Captured output from command ["..last_command.."] to ["..command_capture.."] capture.")
         CallPlugin("dd10517422bc35b5131a3aa0", "switch_to_capture", command_capture)
      end

      temp_buffer = {}
      last_command = ""
   end
end

]]>
</script>
</muclient>
